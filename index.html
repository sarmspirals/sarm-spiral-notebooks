<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SARM SPIRAL NOTEBOOKS | Premium Quality Notebooks Store</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* ALL CSS FROM PREVIOUS FILE (Keep the same styles) */
        /* Copy all CSS from the previous index.html file you have */
        /* It's too long to include here but keep your existing CSS */
    </style>
</head>
<body>
    <!-- ALL HTML FROM PREVIOUS FILE (Keep the same structure) -->
    <!-- Copy all HTML from the previous index.html file you have -->
    <!-- It's too long to include here but keep your existing HTML structure -->

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <!-- Main Application Script - COMPLETE WORKING VERSION -->
    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyB2bfLiik96iccPzM3v7dz-Tc-S_4R4pHc",
            authDomain: "sarm-spiral-notebooks.firebaseapp.com",
            projectId: "sarm-spiral-notebooks",
            storageBucket: "sarm-spiral-notebooks.firebasestorage.app",
            messagingSenderId: "486034342174",
            appId: "1:486034342174:web:a1b964d3a1e8abee90890f",
            measurementId: "G-JCPQTB8KHZ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ============================================
        // GLOBAL VARIABLES - FIXED
        // ============================================
        let currentUser = null;
        let products = [];
        let cart = [];
        let currentOrder = null;

        // Initialize cart from localStorage
        function initCart() {
            try {
                const cartData = localStorage.getItem('sarm_cart');
                if (cartData) {
                    cart = JSON.parse(cartData);
                    if (!Array.isArray(cart)) {
                        cart = [];
                        localStorage.setItem('sarm_cart', JSON.stringify(cart));
                    }
                } else {
                    cart = [];
                }
            } catch (error) {
                console.error("Error loading cart:", error);
                cart = [];
            }
        }

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const productsContainer = document.getElementById('products-container');
        const cartCount = document.querySelector('.cart-count');
        const cartItems = document.getElementById('cart-items');
        const cartTotal = document.getElementById('cart-total');
        const cartSidebar = document.getElementById('cart-sidebar');
        const cartOverlay = document.getElementById('cart-overlay');
        const checkoutModal = document.getElementById('checkout-modal');
        const loginModal = document.getElementById('login-modal');
        const orderTotalDisplay = document.getElementById('order-total-display');
        const orderSummaryItems = document.getElementById('order-summary-items');

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("ðŸš€ Website Initialized");
            initCart();
            initializeAuth();
            loadProducts();
            setupEventListeners();
            updateCartDisplay();
        });

        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        function initializeAuth() {
            auth.onAuthStateChanged((user) => {
                currentUser = user;
                const authButtons = document.getElementById('auth-buttons');
                if (user) {
                    authButtons.innerHTML = `
                        <button class="cta-button" style="padding: 8px 20px;" id="logout-btn">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                        <span style="margin-left: 10px; color: var(--success);">
                            <i class="fas fa-user"></i> ${user.email}
                        </span>
                    `;
                    document.getElementById('logout-btn').addEventListener('click', logoutUser);
                } else {
                    authButtons.innerHTML = `
                        <button class="cta-button" id="login-btn" style="padding: 8px 20px;">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                    `;
                    const loginBtn = document.getElementById('login-btn');
                    if (loginBtn) {
                        loginBtn.addEventListener('click', () => {
                            loginModal.classList.add('active');
                        });
                    }
                }
            });
        }

        function loginUser(email, password) {
            return auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    showToast('Login successful!', 'success');
                    loginModal.classList.remove('active');
                })
                .catch((error) => {
                    showToast('Login failed: ' + error.message, 'error');
                });
        }

        function registerUser(email, password, name, phone) {
            return auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    return db.collection('users').doc(userCredential.user.uid).set({
                        name: name,
                        email: email,
                        phone: phone,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    showToast('Registration successful!', 'success');
                    loginModal.classList.remove('active');
                })
                .catch((error) => {
                    showToast('Registration failed: ' + error.message, 'error');
                });
        }

        function logoutUser() {
            auth.signOut()
                .then(() => {
                    showToast('Logged out successfully', 'success');
                })
                .catch((error) => {
                    showToast('Logout error: ' + error.message, 'error');
                });
        }

        // ============================================
        // PRODUCT FUNCTIONS
        // ============================================
        async function loadProducts() {
            console.log("ðŸ“¡ Loading products...");
            try {
                const snapshot = await db.collection('products').get();
                
                if (!snapshot.empty) {
                    products = [];
                    snapshot.forEach(doc => {
                        products.push({ id: doc.id, ...doc.data() });
                    });
                    console.log("âœ… Products loaded:", products.length);
                    renderProducts();
                } else {
                    console.log("ðŸ“­ No products in Firestore");
                    showToast('No products found', 'warning');
                }
            } catch (error) {
                console.error('âŒ Error loading products:', error);
                showToast('Error loading products', 'error');
            }
        }

        function renderProducts() {
            if (!productsContainer) return;
            
            const loadingSpinner = document.getElementById('loading-spinner');
            if (loadingSpinner) loadingSpinner.style.display = 'none';
            
            productsContainer.innerHTML = '';
            
            products.forEach(product => {
                const cartItem = cart.find(item => item.id === product.id);
                const quantity = cartItem ? cartItem.quantity : 0;
                const availableStock = product.stock - quantity;
                
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    ${availableStock < 5 ? '<span class="product-badge">Low Stock</span>' : ''}
                    <div class="product-image">
                        <i class="fas fa-book"></i>
                    </div>
                    <div class="product-info">
                        <h3 class="product-title">${product.name}</h3>
                        <p class="product-description">${product.description || `${product.pages} pages spiral notebook`}</p>
                        <div class="product-price">â‚¹${product.price}</div>
                        <div class="stock-info">
                            <span>Pages: ${product.pages}</span>
                            <span class="stock-status ${availableStock > 10 ? 'in-stock' : availableStock > 0 ? 'low-stock' : 'out-stock'}">
                                ${availableStock > 10 ? 'In Stock' : availableStock > 0 ? 'Low Stock' : 'Out of Stock'}
                            </span>
                        </div>
                        <div class="quantity-controls">
                            <button class="qty-btn" onclick="updateQuantity('${product.id}', -1)" ${quantity === 0 ? 'disabled' : ''}>
                                <i class="fas fa-minus"></i>
                            </button>
                            <span class="qty-display">${quantity}</span>
                            <button class="qty-btn" onclick="updateQuantity('${product.id}', 1)" ${availableStock <= 0 ? 'disabled' : ''}>
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <button class="add-to-cart" onclick="addToCart('${product.id}')" ${availableStock <= 0 ? 'disabled' : ''}>
                            <i class="fas fa-cart-plus"></i>
                            ${quantity > 0 ? 'Update Cart' : 'Add to Cart'}
                        </button>
                    </div>
                `;
                productsContainer.appendChild(productCard);
            });
        }

        // ============================================
        // CART FUNCTIONS
        // ============================================
        window.updateQuantity = function(productId, change) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const cartIndex = cart.findIndex(item => item.id === productId);
            const currentQty = cartIndex >= 0 ? cart[cartIndex].quantity : 0;
            const newQty = currentQty + change;
            
            if (newQty > product.stock) {
                showToast(`Only ${product.stock} items available`, 'warning');
                return;
            }
            
            if (newQty <= 0) {
                if (cartIndex >= 0) cart.splice(cartIndex, 1);
            } else {
                if (cartIndex >= 0) {
                    cart[cartIndex].quantity = newQty;
                    cart[cartIndex].total = newQty * product.price;
                } else {
                    cart.push({
                        id: productId,
                        name: product.name,
                        price: product.price,
                        quantity: newQty,
                        total: newQty * product.price
                    });
                }
            }
            
            saveCart();
            updateCartDisplay();
            renderProducts();
        };

        window.addToCart = function(productId) {
            updateQuantity(productId, 1);
        };

        function saveCart() {
            localStorage.setItem('sarm_cart', JSON.stringify(cart));
        }

        function updateCartDisplay() {
            if (!Array.isArray(cart)) cart = [];
            
            const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 0), 0);
            if (cartCount) cartCount.textContent = totalItems;
            
            if (cartItems) {
                cartItems.innerHTML = '';
                let total = 0;
                
                if (cart.length === 0) {
                    cartItems.innerHTML = `
                        <div id="empty-cart" style="text-align: center; padding: 40px 20px; color: #666;">
                            <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;"></i>
                            <p>Your cart is empty</p>
                        </div>
                    `;
                } else {
                    cart.forEach(item => {
                        total += (item.total || 0);
                        const cartItem = document.createElement('div');
                        cartItem.className = 'cart-item';
                        cartItem.innerHTML = `
                            <div class="cart-item-info">
                                <h4>${item.name}</h4>
                                <p class="cart-item-price">â‚¹${item.price} Ã— ${item.quantity} = â‚¹${item.total}</p>
                            </div>
                            <div class="cart-item-actions">
                                <button class="qty-btn" onclick="updateQuantity('${item.id}', -1)">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button class="remove-item" onclick="updateQuantity('${item.id}', -${item.quantity})">
                                    Remove
                                </button>
                            </div>
                        `;
                        cartItems.appendChild(cartItem);
                    });
                }
                
                if (cartTotal) cartTotal.textContent = `â‚¹${total}`;
            }
        }

        // ============================================
        // CHECKOUT FUNCTIONS (INVOICE + WHATSAPP)
        // ============================================
        function setupCheckout() {
            if (cart.length === 0) {
                showToast('Your cart is empty!', 'warning');
                return;
            }
            
            // Update order summary
            orderSummaryItems.innerHTML = '';
            let total = 0;
            
            cart.forEach(item => {
                total += item.total;
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; justify-content: space-between; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #eee;';
                div.innerHTML = `
                    <span>${item.name} (${item.quantity})</span>
                    <span>â‚¹${item.total}</span>
                `;
                orderSummaryItems.appendChild(div);
            });
            
            if (orderTotalDisplay) orderTotalDisplay.textContent = `â‚¹${total}`;
            
            closeCart();
            checkoutModal.classList.add('active');
        }

        async function processOrder(orderData) {
            try {
                // Save order to Firestore
                const orderRef = await db.collection('orders').add(orderData);
                const orderId = orderRef.id;
                
                // Update stock
                const batch = db.batch();
                cart.forEach(item => {
                    const productRef = db.collection('products').doc(item.id);
                    batch.update(productRef, {
                        stock: firebase.firestore.FieldValue.increment(-item.quantity)
                    });
                });
                await batch.commit();
                
                // Send WhatsApp alerts
                sendWhatsAppAlerts(orderId, orderData);
                
                // Generate invoice
                generateInvoice(orderId, orderData);
                
                // Clear cart
                cart = [];
                saveCart();
                updateCartDisplay();
                renderProducts();
                
                return orderId;
            } catch (error) {
                console.error('Error processing order:', error);
                throw error;
            }
        }

        // WHATSAPP ALERT FUNCTION
        function sendWhatsAppAlerts(orderId, orderData) {
            // Admin WhatsApp alert
            const adminPhone = '917006927825';
            const adminMessage = encodeURIComponent(
                `ðŸ›’ NEW ORDER RECEIVED!\n\n` +
                `Order ID: ${orderId}\n` +
                `Customer: ${orderData.customerName}\n` +
                `Phone: ${orderData.phone}\n` +
                `Address: ${orderData.address}\n` +
                `Landmark: ${orderData.landmark || 'Near BSNL Tower'}\n` +
                `Pincode: ${orderData.pincode}\n` +
                `Items: ${orderData.items.map(item => `${item.name} (${item.quantity})`).join(', ')}\n` +
                `Total: â‚¹${orderData.totalAmount}\n` +
                `Payment: ${orderData.paymentMethod}\n\n` +
                `Please process this order immediately.`
            );
            
            // Open WhatsApp for admin
            window.open(`https://wa.me/${adminPhone}?text=${adminMessage}`, '_blank');
            
            // Customer WhatsApp alert
            const customerMessage = encodeURIComponent(
                `âœ… ORDER CONFIRMED!\n\n` +
                `Thank you for your order at SARM SPIRAL NOTEBOOKS.\n\n` +
                `Order ID: ${orderId}\n` +
                `Total Amount: â‚¹${orderData.totalAmount}\n` +
                `Payment Method: ${orderData.paymentMethod}\n\n` +
                `Your order will be delivered within 3-5 business days.\n` +
                `We will contact you shortly for delivery details.\n\n` +
                `For queries, call: 7006927825`
            );
            
            // Open WhatsApp for customer
            window.open(`https://wa.me/91${orderData.phone}?text=${customerMessage}`, '_blank');
            
            showToast('WhatsApp alerts sent to admin and customer', 'success');
        }

        // INVOICE GENERATION FUNCTION
        function generateInvoice(orderId, orderData) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Invoice Header
                doc.setFontSize(20);
                doc.text('SARM SPIRAL NOTEBOOKS', 105, 20, { align: 'center' });
                
                doc.setFontSize(10);
                doc.text('KAWOOSA KHALISA, NARBAL, BADGAM | PIN: 193411', 105, 28, { align: 'center' });
                doc.text('Phone: 7006927825 | Email: mir7amir@gmail.com', 105, 34, { align: 'center' });
                
                // Invoice Title
                doc.setFontSize(16);
                doc.text('INVOICE', 105, 45, { align: 'center' });
                
                // Order Details
                doc.setFontSize(10);
                doc.text(`Order ID: ${orderId}`, 20, 60);
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 66);
                
                // Customer Details
                doc.text('Bill To:', 20, 80);
                doc.text(`Name: ${orderData.customerName}`, 20, 86);
                doc.text(`Phone: ${orderData.phone}`, 20, 92);
                doc.text(`Address: ${orderData.address}`, 20, 98);
                doc.text(`Landmark: ${orderData.landmark || 'Near BSNL Tower'}`, 20, 104);
                doc.text(`Pincode: ${orderData.pincode}`, 20, 110);
                
                // Table Header
                doc.setFillColor(240, 240, 240);
                doc.rect(20, 120, 170, 10, 'F');
                doc.text('Item', 25, 127);
                doc.text('Price', 100, 127);
                doc.text('Qty', 130, 127);
                doc.text('Total', 160, 127);
                
                // Table Rows
                let yPos = 135;
                orderData.items.forEach(item => {
                    doc.text(item.name.substring(0, 30), 25, yPos);
                    doc.text(`â‚¹${item.price}`, 100, yPos);
                    doc.text(item.quantity.toString(), 130, yPos);
                    doc.text(`â‚¹${item.total}`, 160, yPos);
                    yPos += 8;
                });
                
                // Total
                yPos += 10;
                doc.setFontSize(12);
                doc.text('Total Amount:', 130, yPos);
                doc.text(`â‚¹${orderData.totalAmount}`, 160, yPos);
                
                // Payment Method
                yPos += 10;
                doc.text(`Payment Method: ${orderData.paymentMethod}`, 20, yPos);
                
                // Footer
                yPos += 20;
                doc.setFontSize(10);
                doc.text('Thank you for your business!', 105, yPos, { align: 'center' });
                doc.text('For any queries, contact: 7006927825', 105, yPos + 6, { align: 'center' });
                
                // Save PDF
                const invoiceName = `Invoice_SARM_${orderId}.pdf`;
                doc.save(invoiceName);
                
                showToast(`Invoice downloaded: ${invoiceName}`, 'success');
                return invoiceName;
            } catch (error) {
                console.error('Error generating invoice:', error);
                showToast('Invoice generation failed, but order is placed', 'warning');
                return null;
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        function setupEventListeners() {
            // Cart toggle
            if (document.getElementById('cart-toggle')) {
                document.getElementById('cart-toggle').addEventListener('click', (e) => {
                    e.preventDefault();
                    cartSidebar.classList.add('open');
                    cartOverlay.classList.add('active');
                });
            }

            // Close cart
            if (document.getElementById('close-cart')) {
                document.getElementById('close-cart').addEventListener('click', closeCart);
            }
            if (cartOverlay) {
                cartOverlay.addEventListener('click', closeCart);
            }

            // Shop now button
            if (document.getElementById('shop-now')) {
                document.getElementById('shop-now').addEventListener('click', () => {
                    document.getElementById('products').scrollIntoView({ behavior: 'smooth' });
                });
            }

            // Checkout button
            if (document.getElementById('checkout-btn')) {
                document.getElementById('checkout-btn').addEventListener('click', setupCheckout);
            }

            // Close modals
            if (document.getElementById('close-checkout')) {
                document.getElementById('close-checkout').addEventListener('click', () => {
                    checkoutModal.classList.remove('active');
                });
            }
            if (document.getElementById('close-login')) {
                document.getElementById('close-login').addEventListener('click', () => {
                    loginModal.classList.remove('active');
                });
            }

            // Login form
            if (document.getElementById('login-form')) {
                document.getElementById('login-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    loginUser(email, password);
                });
            }

            // Register form
            if (document.getElementById('register-form')) {
                document.getElementById('register-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = document.getElementById('register-name').value;
                    const email = document.getElementById('register-email').value;
                    const password = document.getElementById('register-password').value;
                    const phone = document.getElementById('register-phone').value;
                    registerUser(email, password, name, phone);
                });
            }

            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    document.querySelectorAll('.tab-btn').forEach(b => {
                        b.style.background = b === btn ? 'var(--secondary)' : '#ddd';
                        b.style.color = b === btn ? 'white' : 'var(--dark)';
                    });
                    
                    document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
                    document.getElementById('register-form').style.display = tab === 'register' ? 'block' : 'none';
                });
            });

            // Payment method toggle
            document.querySelectorAll('input[name="payment"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.getElementById('upi-qr').style.display = 
                        e.target.value === 'UPI' ? 'block' : 'none';
                });
            });

            // Checkout form submission
            if (document.getElementById('checkout-form')) {
                document.getElementById('checkout-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // Validate phone
                    const phone = document.getElementById('customer-phone').value;
                    if (!/^\d{10}$/.test(phone)) {
                        showToast('Please enter valid 10-digit phone number', 'error');
                        return;
                    }
                    
                    // Validate pincode
                    const pincode = document.getElementById('customer-pincode').value;
                    if (!/^\d{6}$/.test(pincode)) {
                        showToast('Please enter valid 6-digit pincode', 'error');
                        return;
                    }
                    
                    // Prepare order data
                    const orderData = {
                        customerName: document.getElementById('customer-name').value,
                        phone: phone,
                        address: document.getElementById('customer-address').value,
                        landmark: document.getElementById('customer-landmark').value || 'Near BSNL Tower',
                        pincode: pincode,
                        items: cart.map(item => ({
                            productId: item.id,
                            name: item.name,
                            price: item.price,
                            quantity: item.quantity,
                            total: item.total
                        })),
                        totalAmount: cart.reduce((sum, item) => sum + item.total, 0),
                        paymentMethod: document.querySelector('input[name="payment"]:checked').value,
                        status: 'pending',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        userId: currentUser ? currentUser.uid : null
                    };
                    
                    try {
                        const orderId = await processOrder(orderData);
                        showToast(`Order placed successfully! Order ID: ${orderId}`, 'success');
                        
                        // Close modal and redirect
                        checkoutModal.classList.remove('active');
                        window.location.href = `success.html?orderId=${orderId}&success=true`;
                        
                    } catch (error) {
                        console.error('Order error:', error);
                        showToast('Failed to place order. Please try again.', 'error');
                    }
                });
            }

            // Track order link
            if (document.getElementById('track-order-link')) {
                document.getElementById('track-order-link').addEventListener('click', (e) => {
                    e.preventDefault();
                    const orderId = prompt('Enter your Order ID:');
                    if (orderId) {
                        alert(`Order ${orderId} status: Processing\nWe will contact you soon.`);
                    }
                });
            }
        }

        function closeCart() {
            cartSidebar.classList.remove('open');
            cartOverlay.classList.remove('active');
        }

        // ============================================
        // TOAST NOTIFICATION
        // ============================================
        function showToast(message, type = 'success') {
            Toastify({
                text: message,
                duration: 3000,
                gravity: "bottom",
                position: "right",
                style: {
                    background: type === 'success' ? "#27ae60" : 
                              type === 'error' ? "#e74c3c" : "#f39c12",
                },
                stopOnFocus: true
            }).showToast();
        }
    </script>
</body>
</html>
