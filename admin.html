<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - SARM SPIRAL NOTEBOOKS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* COPY ALL CSS FROM YOUR EXISTING admin.html FILE */
        /* Keep your existing CSS styles */
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-screen">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-user-shield"></i>
            </div>
            <h2>Admin Login</h2>
            <p>Enter your credentials to access the admin panel</p>
            <form id="admin-login-form">
                <div class="form-group">
                    <input type="email" id="admin-email" placeholder="Admin Email" required
                           style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div class="form-group">
                    <input type="password" id="admin-password" placeholder="Password" required
                           style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <button type="submit" class="btn-save" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> Login as Admin
                </button>
            </form>
            <p style="margin-top: 20px; font-size: 0.9rem; color: #666;">
                <i class="fas fa-info-circle"></i> Use: admin@sarm.com / admin123
            </p>
        </div>
    </div>

    <!-- Admin Dashboard (Initially Hidden) -->
    <div id="admin-dashboard" style="display: none;">
        <!-- Copy the rest of your admin.html dashboard HTML here -->
        <!-- Keep your existing admin dashboard structure -->
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Admin JavaScript - FIXED LOGIN -->
    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyB2bfLiik96iccPzM3v7dz-Tc-S_4R4pHc",
            authDomain: "sarm-spiral-notebooks.firebaseapp.com",
            projectId: "sarm-spiral-notebooks",
            storageBucket: "sarm-spiral-notebooks.firebasestorage.app",
            messagingSenderId: "486034342174",
            appId: "1:486034342174:web:a1b964d3a1e8abee90890f",
            measurementId: "G-JCPQTB8KHZ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ============================================
        // SIMPLE ADMIN LOGIN SYSTEM
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Check if already logged in
            checkAdminLogin();
            
            // Login form submission
            document.getElementById('admin-login-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('admin-email').value;
                const password = document.getElementById('admin-password').value;
                
                // SIMPLE ADMIN CREDENTIALS (Change these in production!)
                const ADMIN_EMAIL = "admin@sarm.com";
                const ADMIN_PASSWORD = "admin123";
                
                if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
                    // Successful login
                    localStorage.setItem('admin_logged_in', 'true');
                    localStorage.setItem('admin_email', email);
                    
                    // Show admin dashboard
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('admin-dashboard').style.display = 'block';
                    
                    // Load admin data
                    loadAdminData();
                    
                    alert('Admin login successful!');
                } else {
                    // Try Firebase login as fallback
                    try {
                        await auth.signInWithEmailAndPassword(email, password);
                        localStorage.setItem('admin_logged_in', 'true');
                        localStorage.setItem('admin_email', email);
                        
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('admin-dashboard').style.display = 'block';
                        loadAdminData();
                        
                        alert('Admin login successful!');
                    } catch (error) {
                        alert('Invalid admin credentials');
                    }
                }
            });
            
            // Logout button
            document.getElementById('admin-logout').addEventListener('click', function() {
                localStorage.removeItem('admin_logged_in');
                localStorage.removeItem('admin_email');
                auth.signOut();
                location.reload();
            });
        });

        function checkAdminLogin() {
            const isLoggedIn = localStorage.getItem('admin_logged_in');
            if (isLoggedIn === 'true') {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('admin-dashboard').style.display = 'block';
                loadAdminData();
            }
        }

        // ============================================
        // ADMIN DATA LOADING
        // ============================================
        async function loadAdminData() {
            console.log("Loading admin data...");
            
            try {
                // Load orders
                const ordersSnapshot = await db.collection('orders').orderBy('timestamp', 'desc').get();
                const orders = [];
                ordersSnapshot.forEach(doc => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                
                // Load products
                const productsSnapshot = await db.collection('products').get();
                const products = [];
                productsSnapshot.forEach(doc => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                
                // Update dashboard
                updateDashboard(orders, products);
                loadOrdersTable(orders);
                loadProductsTable(products);
                
            } catch (error) {
                console.error("Error loading admin data:", error);
                alert("Error loading data. Check console.");
            }
        }

        function updateDashboard(orders, products) {
            // Update stats
            document.getElementById('total-orders').textContent = orders.length;
            
            const totalRevenue = orders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
            document.getElementById('total-revenue').textContent = `₹${totalRevenue}`;
            
            const pendingOrders = orders.filter(order => order.status === 'pending').length;
            document.getElementById('pending-orders').textContent = pendingOrders;
            
            const lowStockProducts = products.filter(product => product.stock < 10).length;
            document.getElementById('low-stock-count').textContent = lowStockProducts;
        }

        function loadOrdersTable(orders) {
            const tbody = document.getElementById('all-orders-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            orders.forEach(order => {
                const date = order.timestamp ? order.timestamp.toDate().toLocaleDateString() : 'N/A';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${order.id.substring(0, 8)}...</td>
                    <td>${order.customerName}</td>
                    <td>${order.phone}</td>
                    <td>₹${order.totalAmount || 0}</td>
                    <td>
                        <select class="status-select" data-order-id="${order.id}">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                            <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                            <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </td>
                    <td>${date}</td>
                    <td>
                        <button class="btn-action btn-view" onclick="viewOrder('${order.id}')">View</button>
                        <button class="btn-action btn-whatsapp" onclick="whatsappCustomer('${order.phone}')">WhatsApp</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners for status changes
            document.querySelectorAll('.status-select').forEach(select => {
                select.addEventListener('change', function() {
                    updateOrderStatus(this.dataset.orderId, this.value);
                });
            });
        }

        function loadProductsTable(products) {
            const container = document.getElementById('products-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-admin-card';
                card.innerHTML = `
                    <div class="product-header">
                        <h4>${product.name}</h4>
                        <span class="stock-status ${product.stock > 10 ? 'in-stock' : product.stock > 0 ? 'low-stock' : 'out-stock'}">
                            Stock: ${product.stock}
                        </span>
                    </div>
                    <p style="color: #666; font-size: 0.9rem;">${product.description || 'No description'}</p>
                    <div class="product-price">₹${product.price}</div>
                    <div class="product-actions">
                        <button class="btn-edit" onclick="editProduct('${product.id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn-delete" onclick="deleteProduct('${product.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // ============================================
        // ADMIN FUNCTIONS
        // ============================================
        async function updateOrderStatus(orderId, status) {
            try {
                await db.collection('orders').doc(orderId).update({
                    status: status,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert(`Order status updated to ${status}`);
                loadAdminData(); // Reload data
            } catch (error) {
                console.error("Error updating order:", error);
                alert("Failed to update order status");
            }
        }

        window.viewOrder = function(orderId) {
            alert(`View order ${orderId} - Details will be shown here`);
            // You can implement a modal to show order details
        };

        window.whatsappCustomer = function(phone) {
            const message = encodeURIComponent(
                `Hello! This is SARM SPIRAL NOTEBOOKS.\n\n` +
                `Regarding your order.\n` +
                `How can we assist you today?`
            );
            window.open(`https://wa.me/91${phone}?text=${message}`, '_blank');
        };

        window.editProduct = function(productId) {
            alert(`Edit product ${productId} - Implement edit functionality`);
            // You can implement a modal to edit product
        };

        window.deleteProduct = async function(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    await db.collection('products').doc(productId).delete();
                    alert('Product deleted successfully');
                    loadAdminData(); // Reload data
                } catch (error) {
                    console.error("Error deleting product:", error);
                    alert("Failed to delete product");
                }
            }
        };
    </script>
</body>
</html>
